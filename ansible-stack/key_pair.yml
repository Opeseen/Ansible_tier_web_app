- hosts: localhost
  connection: local
  gather_facts: False
  tasks:
    - name: Create EC2 Key Pair
      ec2_key:
        name: nodejs
        region: us-east-1
      register: keyout

    - name: Store Login Key
      copy:
        content: "{{keyout.key.private_key}}"
        dest: ./nodejs_key.pem
        mode: '0400'
      when: keyout.changed

    - name: Store Login key name as variable
      blockinfile:
        path: vars/variables.yml
        marker: "# {mark} ANSIBLE MANAGED BLOCK FOR {{keyout.key.name}} Keypair Name"
        block: |
          key_name: {{keyout.key.name}}
    
    - name: Add mappings to /etc/hosts
      blockinfile:
        path: /tmp/host
        create: True
        block: |
          {{ item.ip }} {{ item.name }}
        marker: "# {mark} ANSIBLE MANAGED BLOCK {{ item.name }}"
      loop:
        - { name: host1, ip: 10.10.1.10 }
        - { name: host2, ip: 10.10.1.11 }
        - { name: host3, ip: 10.10.1.12 }